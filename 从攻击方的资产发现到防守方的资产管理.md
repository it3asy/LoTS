# 从攻击方的资产发现到防守方的资产管理


//2019/09

## 前言

笔者作为乙方安全工程师，客串了几次攻防演练行动攻击方，之后根据经历的一些具体的渗透案例，就“资产发现“这个主题面向部门安全服务工程师们做了一个内部分享。本文修改自这次的分享材料，算是对[<从资产发现到风险监测>](https://github.com/it3asy/LoTS/blob/master/%E4%BB%8E%E8%B5%84%E4%BA%A7%E5%8F%91%E7%8E%B0%E5%88%B0%E9%A3%8E%E9%99%A9%E7%9B%91%E6%B5%8B.md)这个文本的一个呼应。以下正文。  



## 一、案例回顾

几次演练行动中的多数成功攻击案例都是这么一个过程场景：**攻击从互联网发起，找到目标单位暴露在互联网上的安全漏洞突破到单位内网，内网渗透获得相应权限结束战斗**。在这个场景里，攻击过程可以分解为两个环节：  

1）通过目标单位暴露在互联网的安全漏洞进到内网；  
2）后续的内网渗透过程。

前者又可以分为寻找目标单位的互联网信息资产、发现资产存在的漏洞并利用，漏洞检测及利用不是本文要讨论的，本文主要讲讲前者，即：**我们怎么找到那些存在漏洞的信息资产的，以及作为防守方，我们在安全运维工作中应该怎么应对这种攻击过程。**


先来看几个实际案例中目标单位是怎么被突破的:

- **目标1**: 某带VPN功能的网络设备存在SSH弱口令，登陆后配置VPN后接入，进而开始渗透内网。
- **目标2**：某个Web应用存在存在源码备份文件，从源码中找到MySQL的root帐号密码，登录phpMyAdmin写入WebShell，进而开始渗透内网。
- **目标3**：某个Web应用存在管理员弱口令，登录后发现使用了eWeb编辑器，通过默认密码登陆编辑器后台上传WebShell，进而开始渗透内网。
- **目标4**：某个Web应用存在s2-016漏洞，Payload变形后绕过防护设备获得WebShell，进而开始渗透内网。
- **目标5**：某个Web应用存在Shiro反序死漏洞，直接反弹Shell控制服务器，进而开始渗透内网。
- **目标6**：某个Web应用存在弱口令，登录后发现上传功能存在任意文件上传漏洞获得WebShell，进而开始渗透内网。

可以看到，这些目标最终被突破都是从一些最初的漏洞点开始引发的连锁反应。以下分别用1.1.1.1~7.7.7.7来代替真实的互联网IP地址，用URL来标记具体的信息资产，那么漏洞点分别发生在：

	1. ssh://1.1.1.1:10022				-> 弱口令 + 配置VPN接入
	2. http://2.2.2.2:10082/			-> 目录遍历 + 源码泄露密码等
	3. http://3.3.3.3:8090/kfweb/		-> Shiro反序列化
	4. http://4.4.4.4:8000/report/		-> 弱口令 + 任意文件上传
	5. http://5.5.5.5:8001/DP/			-> S2-016 + 防护设备绕过
	6. http://6.6.6.6:7002/bpm/			-> WebService任意文件写入
	7. http://7.7.7.7:8085/gcgl/		-> 弱口令 + 任意文件上传


如果只看最初的漏洞点（+号前面的），弱口令/Struts2/源码泄露/反序列化等等，都是些相对常见且容易检测的安全漏洞。而现在的问题是，要检测这些漏洞，**我们首先是如何找到这些信息资产呢**？



## 二、寻找突破口

简而言之，寻找突破口无非先找目标单位的信息资产，再看资产有没有安全漏洞。具体的，我们会沿着以下的过程寻找突破口:

### 1. IP地址收集

不多说，比如我们收集到目标单位互联网IP范围：

	1.1.1.1 ~ 6.6.6.6


### 2. 端口扫描

对目标IP范围进行端口扫描和服务识别，得到：

	1. ssh://1.1.1.1:10022
	2. http://2.2.2.2:10082
	3. http://3.3.3.3:8090
	4. http://4.4.4.4:8000
	5. http://5.5.5.5:8001
	6. http://6.6.6.6:7002
	7. http://7.7.7.7:8085

当然还有很多其它端口，但与本文内容无关。此时，目标1和目标2的突破口资产已经找到，而3、4、5、6、7的突破口还没找到（访问都是空白或者中间件默认页面）。


### 3. 二级目录应用发现

很多http服务直接访问后看不到正常的Web应用页面，而是一些中间件默认页面/HTTP错误/空白页面，这说明它们的Web应用部署在了二级目录（子域名的问题后文说明）。对于目标3、4、5、6、7就是这种情况，那么，我们又是怎么找到这些二级目录的Web应用的呢？  

我们采取了这些方法：  

- 1）从已经收集到目标单位的Web应用（主要是信息发布站，如门户网站、微信公众号等）寻找外链，此时，我们找到目标3突破口对应的Web应用。 

- 2）对、5、6、7使用常用Web应用目录名字典对相应的HTTP入口进行目录扫描，找到了目标4突破口对应的Web应用。

- 3）对剩下的目标5、6、7进行暴力猜解，最终找到目标5、6、7突破口。

这里暂且把方法2、3我们统称为二级目录Web应用猜解，其中2称之为常用目录名扫描，3称之为暴力猜解。猜解尤其暴力猜解总是一个低效的过程，怎么把这个低效的过程做得高效一点？这个后文简单说说。

至此，上面所有的目标突破口资产都被找到，剩下的就是检测资产漏洞及利用了，不在本文范围之内。



## *四、 关于二级目录Web应用猜解


这部分内容只为分享一些细节经验，和本文主线逻辑无关。

二级目录Web应用猜解就像扫描网站后台一样。目录扫描工具很多，自己写起来也简单，我习惯用一个自己写的python2脚本：`http://github.com/it3asy/py-scans/scandirs.py`。目录扫描工具不是重点，重点是目录字典。


### 常用目录字典扫描

很多Web应用目录名字是普遍通用的，比如oa、mail等等，还有些是在某个范围内通用的，比如河南某个单位的目录名，那河北相同单位很可能也有...我们可以通过各种方法渠道去积累常用目录名字典。比如子域名命名和Web应用目录名就很有相通之处，子域名爆破字典也就可以拿过来猜解Web应用。

当使用以上常用二级目录名字典猜解不出来的时候，我们就需要扩大字典范围了。一个二级目录名字基本上不大可能是随机取的，一般可能是某个特定的词汇。可能是一个词语拼音缩写，如`固定资产/gdzc`、`网上办事/wsbs`），或者是完整拼音，如`申报/shenbao`，又或者是一个英语单词（如`门户/portal`），等等，所以英语单词表汉语短语拼音都可以作为目录字典，英语单词字典是好收获得的，汉语词汇不是很好收集，可以从中文分词相关的词汇库提取。暂且把这类字典称之为常规字典。


### 暴力猜解

当常用字典和常规字典都扫不出来的时候，就要考虑暴力破解了。而对于暴力猜解，这就是个数据和文本处理的事了。

基本上，三位及以下的（目标5、6）二级目录名我们可以把所有组合跑一遍，比如完全扫描一遍3位小写字母构成的目录需要26\*26\*26约不到2万次，一般还在可接受范围内。

从4位开始就不大可能完整轮一遍了，完整地猜一遍只由4位由小写字母组合，需要向服务器请求26\*26\*25\*26约50万次，到了5位那就是1000万次，毕竟我们是在攻防演练，不可能发起这么大量的请求。但有时候又实在找不到其它突破口，那又该怎么办呢？一个Web应用的目录名通常不是随机取的，而是有某种含义，这意味着在一个语义场景里不同的字符出现的概率是不一样的，我们只需要猜解概念较大的而抛弃那些概率较小的。比如`g`后面出现`l`的概率一般要大于`g`后面出`g`的概率，前者可能是'公路'、'管理'等意思，文本分析里有各种各样的概率计算模型，比如最基本的条件概率：

目录`abcd`出现的概率 = `a`出现的概率 \* `a`后`b`出现的概率 * `b`后`c`出现的概率 * `c`后`d`出现的概率，即 P(abcd) = P(a) \* P(b|a) \* P(c|b)\* P(d|c)

而相应的p(a)、p(b|a)、p(c|b)、p(d|c)就需要制作针对性的词库统计词频来获得了。

上面的概率计算只是表示是我们只需要尝试较少组合就可能获得较多结果这知个逻辑。在实际中，我们只会尝试4位的情况，多于4位放弃，少于4位遍历。而根据汉语习惯，对于4位的目录名，可以看作是2个2元词的组合，如固定资产（gdzc)=固定(gd)+资产(zc)，这样只需要收集好常用2元词表再遍历组合就行了。目标6突破口就是这样猜解出来的。

总而言之，关于Web应用目录猜解的效率而言，根据我的经验，其效率是常用字典>常规字典>暴力猜解。


## 四、小结

前面回顾了几个实际的渗透案例中寻找到外部突破口的过程。然后稍稍讲了一些关于Web应用目录猜解的细节，因为二级目录Web应用是我们整个资产发现过程中的核心。上述从IP到二级目录Web应用，这个过程中我忽略了子域名，原因是，在我们面临的环境中，基本上一个Web应用不会既绑定了二级目录又绑定了子域名，所以子域名挖掘可以单独作为一个过程讨论，但因为相关讨论网上到处都是，我这就不多说了。  


## 五、防守方怎么应对

了解前面讲的攻击过程，那么作为防守方，在日常安全运维工作中应该怎么去应对呢？防守方的工作的是方方面面的，对应于攻击过程中的寻找漏洞突破口，下面我们从漏洞检测这个角度来说说工作要做到哪些方面以及到什么程度。


### 1. 漏洞扫描工作的资源配备

单就上面攻击过程列举的漏洞来说（不考虑URL），有些漏洞是扫描器能发现的漏洞，如Struts漏洞；有些是扫描器不能发现的漏洞，比如弱口令、编辑器漏洞等。也就是说，要在漏洞检测工作中覆盖上面提到的漏洞，一些基础组件框架级别的漏洞检测（struts）是漏扫可以实现的，而弱口令层次的漏洞检测则需要专门的人工检查来实现，而一些场景化、灵活性的Web应用层面的安全漏洞检测则需要有一定Web安全经验工程师来实现。  

简言之，在漏洞检测工作中完成应用前面讲的攻击过程，我们需要有专门的Web安全工程师的人力投入才行。然后我们才来谈谈有了人然后怎么落实工作。


### 2. 漏洞扫描中的资产发现

攻击方为了发现漏洞突破口会做资产发掘，那么作为防守方要做就是消除这些漏洞突破口同样要做资产发掘。如果把前面攻击过程列的资产数据分为三个层级：

1）IP范围级别；  
2）端口服务级别；  
3）Web应用级别（包含二级目录应用）；  

显然，每个层级都依赖于上一个层级，而在安全运维中我们的资产发现就需要覆盖到这三个层级的资产信息。并且，**每个级别的资产信息应该比攻击者们掌握的更全面**。怎么做到这一点呢？

*大家可能经常看到，在Web应用级别可以有再下一个级别，Web指纹级别，但一般我们的客户单位里不大需要做到这个级别*


#### 2.1 IP范围收集

这个对于安全运维工作来说最基本东西不多说。

如果资产发现只做到IP地址级别，我们只对所有IP进行漏洞扫描，而在任务配置里又没有选上全端口扫描（即使选上也可能会因为各种原因遗漏），那么那些在非默认的端口的资产是覆盖不到的。


#### 2.2 端口及服务

有别于攻击者，作为运维者肯定不能靠端口扫描去获取单位的外网开放端口列表。通常情况下，互联网开放端口都是从内网映射出去的，这些映射规则或者在出口防火墙里，或者在负载里，不同单位可能不一样。在防火墙里的一般是做NAT映射，规则很直观，内网IP端口对应外网IP端口。而负载里的逻辑稍微复杂些，它有NAT地址转换和虚拟服务两种方式。而作为乙方人员我们怎么拿到这些配置，这是工作层面的问题而不是技术层面的问题了。


#### 2.3 Web应用系统列表

前面IP到端口服务都可以说是铺垫，Web应用系统才是主角。可以看到攻击过程中的突破口大多发生在Web应用上，Web应用里又大多发生在二级目录Web应用上，而实际上部署在根目录下的Web应用是多于二级目录应用的。

*之所以如此，是因为根目录下Web应用更容易被发现，不管是内部的安全运维、还是外部安全监管单位、还是外面的攻击都们都很容易照顾到它们，而很多二级目录的Web应用则常常被遗忘。*

如果依靠平常人工的资产登记管理，根据我的经验，基本上不管哪个单位里都不会得到完整的Web应用系统列表。怎么通过技术手段获得完整的Web应用系统列表呢？

我们把Web应用系统分为在根目录下的和二级目录下的。那么，从开放端口列表中提取HTTP服务的时候，在根目录下的Web应用就都被覆盖到了，其中部分在二级目录Web应用在访问根目录也会跳转过去，相当于也被收集了；但还剩下一部分，也就是我们前面二级目录应用猜解过程发现那些，这些不能被收集到的，应该怎么解决呢？

作为内部的安全运维人员，和外部攻击者一样去靠猜解显然是不合适的，最可靠的做法是从流量中提取，并适当辅以外部猜解。之所有还要去猜解是因为有一些特殊情况，比如系统可能废弃了，根本就没人访问，流量中自然也没有；又或者有些走HTTPS协议的，流量中提取不了。至于怎么从流量中发现二级目录应用，这是个单纯的技术问题，这里不多说了。


## 六、 工作怎么持续化


安全运维工作不是一次性的而是持续性的，前面介上绍了安全运维中怎么获得完整的互联网资产信息列表，但这在工作中要怎么落地呢，怎么维持我们的资产列表总最新最全的？

资产发现到资产清单的持续维护更新，我们暂且统称之为安全运维中的资产管理工作。简单来说，首先资产管理要在整个运维工作体系中要当成一项工作去做，换言之就是平常得有人持续性的去做资产管理的事。我们的安全服务工作有很多标准服务内容，渗透测试/应急响应/漏洞监测等等，但没有“资产管理”这么一项，所以一般也没人专门做这个事。

根据我的经验，资产较少的网络环境里（几个几十个），一个人拿个Excel表结合前面谈的资产发现手段也就可以维护了，资产较多的网络环境要想再有效地维护数据，那数据库、自动化任务脚本、一些基本的增删改查功能的交互操作界面基本不可或缺了，就是说需要构建工程化的资产管理系统来维护了，换句话说就是需要投入研发人力。

关于怎么实现一个资产管理系统，参考[<从资产发现到风险监测>](https://github.com/it3asy/LoTS/blob/master/%E4%BB%8E%E8%B5%84%E4%BA%A7%E5%8F%91%E7%8E%B0%E5%88%B0%E9%A3%8E%E9%99%A9%E7%9B%91%E6%B5%8B.md)这个文本。

*从资产发现到漏洞检测，大家日常也可以去关注一些这方面的产品，看看这些产品应用到我们接触的网络环境里能不能适用。*


##　七、结语

上面说了这么多，总结起来所有讨论都可以归结到攻/防视角中的网络资产发现/管理这个主题上来，而从技术工作层面来说就是实现“从IP范围到端口服务到Web应用列表”这个资产数据发现过程。

我们很多时候总是想从攻击视角中看到防守的一些“什么”，但每次听完看完攻击案例似乎又没有得到一些想要的“什么”。一方面，攻击会对防守每一个层面发起挑战，如果从完整的攻击过程来看防守，这其实没什么好谈的。因为从多个攻击案例来看，那么攻击会折射防守的每一个层面，相应的无非是把整个安全运维管理体系再说一遍；而从单独的攻击案例去看防守，要么是陷入一些具体的技术细节讨论要么无从讨论。另一方面，因为我们是作为乙方提供安全服务，并非甲方单位的安全运维部门，因而也不大会从持续化的安全运维工作视角看待攻防问题。而本文是想从多个攻击案例中提炼一种通用模式，基于这个模式来看攻防问题。

如果注意的话，会发现我在资产管理的过程同样忽略了子域名。有兴趣的话可以想想把域名加到这个过程里，情况又会是怎么样的呢？

本文是从互联网资产视角引入的安全运维视角下的资产管理，更多时候我们是从内网视角去看网络资产。内网资产还是互联网资产，对于这里的资产发现过程来说区别不大。掌握内网资产表，再掌握内外网映射关系表，也就掌握互联网资产表了。

本文所谈主要对类似这几次攻防演练中遇到一些较大型的单位网络的案例而言，其它场合可能适用可能不适用。

太晚就写到这吧，写的比较随性，有的说的多有的说的少，跟重不重点关系不大。大家有兴趣的也可以平时找我讨论交流。

